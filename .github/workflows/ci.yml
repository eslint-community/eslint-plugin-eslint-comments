name: CI
on:
    push:
        branches:
            # default semantic-release branches
            - +([0-9])?(.{+([0-9]),x}).x
            - main
            - next
            - next-major
            - beta
            - alpha
    pull_request:
    schedule:
        - cron: 0 0 * * 0

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: write # to be able to publish a GitHub release
    id-token: write # to enable use of OIDC for npm provenance
    issues: write # to be able to comment on released issues
    pull-requests: write # to be able to comment on released pull requests

jobs:
    lint:
        name: â¬£ Lint
        runs-on: ubuntu-latest
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: ğŸ“¥ Install dependencies
              run: npm install

            - name: ğŸ“¥ Build
              run: npm run build

            - name: â–¶ï¸ Run lint script
              run: npm run lint

    test:
        name:
            ğŸ§ª Test (Node@${{ matrix.node }} - ESLint@${{ matrix.eslint }} - ${{
            matrix.os }})
        strategy:
            fail-fast: false
            matrix:
                eslint: [9]
                node: [20, 22, 24]
                os: [ubuntu-latest]
                include:
                    # On other platforms
                    - os: windows-latest
                      eslint: 9
                      node: 24
                    - os: macos-latest
                      eslint: 9
                      node: 24
                    - eslint: 8.57.0
                      node: 24
                      os: ubuntu-latest
        runs-on: ${{ matrix.os }}
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup Node v${{ matrix.node }}
              uses: actions/setup-node@v6
              with:
                  node-version: ${{ matrix.node }}
                  check-latest: true

            - name: ğŸ“¥ Install dependencies
              run: npm install --legacy-peer-deps

            - name: ğŸ“¥ Build
              run: npm run build

            - name: ğŸ“¥ Install ESLint v${{ matrix.eslint }}
              run: npm install --save-dev eslint@${{ matrix.eslint }}

            - name: ğŸ“¥ Install @types/eslint
              if: startsWith(matrix.eslint, '8')
              run: npm install --save-dev @types/eslint -f

            - name: â–¶ï¸ Run test script
              run: npm run test

            - name: â¬†ï¸ Upload coverage report
              uses: codecov/codecov-action@v5

    are-the-types-wrong:
        name: ğŸ¤” Are the types wrong?
        runs-on: ubuntu-latest
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: ğŸ“¥ Install dependencies
              run: npm install --legacy-peer-deps

            - name: â–¶ï¸ Run check-exports script
              run: npm run check-exports -- --format=table

            - name: â–¶ï¸ Run typecheck script
              run: npm run typecheck

    type-tests:
        name: ğŸ§ª Type tests with ESLint ${{ matrix.eslint }} and TypeScript ${{ matrix.ts }}
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false

            matrix:
                eslint: [9]
                ts: ["5.7", "5.8", "5.9"]

        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup Node
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: ğŸ“¥ Install dependencies
              run: npm install

            - name: Pack the package
              id: pack
              run: npm install "$(npm pack | tail -n1)"

            - name: ğŸ“¥ Install ESLint version ${{ matrix.eslint }}
              run: npm install --save-dev eslint@${{ matrix.eslint }}

            - name: ğŸ“¥ Install @types/eslint
              if: startsWith(matrix.eslint, '8')
              run: npm install --save-dev @types/eslint@^8 -f

            - name: ğŸ“¥ Install TypeScript version ${{ matrix.ts }}
              run: npm install --save-dev typescript@${{ matrix.ts }} -f

            - name: â–¶ï¸ Run typecheck script
              run: npm run typecheck

    release:
        name: ğŸš€ Release
        needs: [are-the-types-wrong, lint, test, type-tests]
        runs-on: ubuntu-latest
        if:
            github.repository == 'eslint-community/eslint-plugin-eslint-comments' &&
            contains('refs/heads/main,refs/heads/next,refs/heads/beta,refs/heads/alpha',
            github.ref) && github.event_name == 'push'
        steps:
            - name: â¬‡ï¸ Checkout repo
              uses: actions/checkout@v6

            - name: â” Setup node
              uses: actions/setup-node@v6
              with:
                  node-version: lts/*

            # npm 11.5.1 or later is required so update to latest to be sure
            - name: Update npm
              run: npm install -g npm@latest

            - name: ğŸ“¥ Install dependencies
              run: npm install --legacy-peer-deps

            - name: ğŸš€ Release
              uses: cycjimmy/semantic-release-action@v6
              with:
                  # semantic-release@v25 is required for trusted publishing.
                  # https://github.com/semantic-release/semantic-release/releases/tag/v25.0.1
                  semantic_version: 25
                  branches: |
                      [
                        '+([0-9])?(.{+([0-9]),x}).x',
                        'main',
                        'next',
                        'next-major',
                        {name: 'beta', prerelease: true},
                        {name: 'alpha', prerelease: true}
                      ]
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_CONFIG_PROVENANCE: true
